!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).createKindeClient=t()}(this,(function(){"use strict";const e="pkce-code-verifier";async function t(e){const t=await function(e){const t=(new TextEncoder).encode(e);return window.crypto.subtle.digest("SHA-256",t)}(e);return o=t,btoa(String.fromCharCode.apply(null,new Uint8Array(o))).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"");var o}function o(){const e=new Uint32Array(28);return window.crypto.getRandomValues(e),Array.from(e,(e=>("0"+e.toString(16)).substr(-2))).join("")}return async r=>{if(!r)throw Error("Please provide your Kinde credentials");if(r!==Object(r))throw Error("The Kinde SDK must be initiated with an object");const{redirect_uri:n,domain:a,is_live:i=!0,logout_uri:s=n}=r;if(!n||"string"!=typeof r.redirect_uri)throw Error("Please supply a valid redirect_uri for your users to be redirected after successful authentication");if(!a||"string"!=typeof a)throw Error("Please supply a valid Kinde domain so we can connect to your account");if("boolean"!=typeof i)throw TypeError("Please supply a boolean value for is_live");const c=i?"spa@live":"spa@sandbox",d={client_id:c,redirect_uri:n,authorization_endpoint:`${a}/oauth2/auth`,token_endpoint:`${a}/oauth2/token`,requested_scopes:"openid offline",domain:a},l=async()=>{const e=localStorage.getItem("kinde_token");if(e)try{const t=JSON.parse(e),o=await fetch(d.token_endpoint,{method:"POST",headers:new Headers({"Content-type":"application/x-www-form-urlencoded; charset=UTF-8"}),body:new URLSearchParams({client_id:d.client_id,grant_type:"refresh_token",refresh_token:t.refresh_token})}),r=await o.json();return localStorage.setItem("kinde_token",JSON.stringify(r)),r.access_token}catch(e){console.log(e)}};await l();const u=async r=>{const{state:a,code_challenge:i,url:s}=await(async()=>{const r=o(),n=o(),a=await t(n);return sessionStorage.setItem(`${e}-${r}`,n),{state:r,code_challenge:a,url:new URL(d.authorization_endpoint)}})();s.search=new URLSearchParams({redirect_uri:n,client_id:c,response_type:"code",scope:d.requested_scopes,code_challenge:i,code_challenge_method:"S256",state:a,start_page:r}),window.location=s};return{getToken:l,getUser:async()=>{const e=localStorage.getItem("kinde_token"),t=JSON.parse(e);if(t)try{const e=await fetch(`${a}/oauth2/user_profile`,{headers:new Headers({Authorization:"Bearer "+t.access_token})});return await e.json()}catch(e){console.log(e)}},handleRedirectCallback:async()=>{const t=new URLSearchParams(window.location.search);if(!t.has("code"))return{};const o=t.get("code"),r=t.get("state"),n=t.get("error");n&&console.error(`Error returned from authorization server: ${n}`);const a=sessionStorage.getItem(`${e}-${r}`);if(a)try{const t=await fetch(d.token_endpoint,{method:"POST",headers:new Headers({"Content-type":"application/x-www-form-urlencoded; charset=UTF-8"}),body:new URLSearchParams({client_id:d.client_id,code:o,code_verifier:a,grant_type:"authorization_code",redirect_uri:d.redirect_uri})}),n=await t.json();localStorage.setItem("kinde_token",JSON.stringify(n));return new URL(window.location).search="",sessionStorage.removeItem(`${e}-${r}`),{kindeState:n}}catch(t){console.log(t),sessionStorage.removeItem(`${e}-${r}`)}else console.error("Invalid state")},login:async()=>{await u("login")},logout:async()=>{const e=new URL(`${d.domain}/logout`);try{localStorage.removeItem("kinde_token"),e.search=new URLSearchParams({redirect:s}),window.location=e}catch(e){console.log(e)}},register:async()=>{await u("registration")}}}}));
